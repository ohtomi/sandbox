{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "Api Server template",
    "Parameters" : {
        "KeyName" : {
            "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the api server via the bastion server",
            "Type" : "String"
        },
        "InstanceType" : {
            "Description" : "EC2 instance type for the api server",
            "Default" : "t1.micro",
            "Type" : "String"
        },
        "VPC" : {
            "Description" : "VPC Id for the api server",
            "Type" : "String"
        },
        "ApiServerSubnet" : {
            "Description" : "Subnet Id for the api server",
            "Type" : "String"
        },
        "VPCDefaultSecurityGroup" : {
            "Description" : "Security Group Id for the api server",
            "Type" : "String"
        },
        "GrowthForecastURL" : {
            "Description" : "URL for GrowthForecast api endpoint",
            "Type" : "String"
        }
    },
    "Mappings" : {
        "RegionToAMI" : {
            "ap-northeast-1" : { "AMI" : "ami-a1bec3a0" }
        },
        "ContentToURL" : {
            "jdk-8u77" : { "URL" : "http://jdk-8u77.s3-website-ap-northeast-1.amazonaws.com/jdk-8u77-linux-x64.rpm" }
        }
    },
    "Resources" : {
        "ApiServerSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "VpcId" : { "Ref" : "VPC" },
                "GroupDescription" : "Enable Web access to the api server via port 80",
                "SecurityGroupIngress" : [
                    { "IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0" }
                ]
            }
        },
        "ApiServer" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "ImageId" : { "Fn::FindInMap" : [ "RegionToAMI", { "Ref" : "AWS::Region" }, "AMI" ]},
                "InstanceType" : { "Ref" : "InstanceType" },
                "SubnetId" : { "Ref" : "ApiServerSubnet" },
                "SecurityGroupIds" : [
                    { "Ref" : "VPCDefaultSecurityGroup" },
                    { "Ref" : "ApiServerSecurityGroup" }
                ],
                "KeyName" : { "Ref" : "KeyName" },
                "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "yum update -y\n",
                    "yum update -y aws-cfn-botstrap\n",

                    "/opt/aws/bin/cfn-init ",
                    "    --stack ", { "Ref" : "AWS::StackId" },
                    "    --resource ApiServer",
                    "    --region ", { "Ref" : "AWS::Region" }, "\n",

                    "/opt/aws/bin/cfn-signal -e $? ",
                    "    --stack ", { "Ref" : "AWS::StackId" },
                    "    --resource ApiServer",
                    "    --region ", { "Ref" : "AWS::Region" }, "\n"
                ]]}}
            },
            "Metadata" : {
                "AWS::CloudFormation::Init" : {
                    "configSets" : {
                        "default" : [ "SetupRepos", "Install", "Configure", "Start" ]
                    },
                    "SetupRepos" : {
                        "files" : {
                            "/etc/yum.repos.d/td.repo" : {
                                "content" : { "Fn::Join" : [ "", [
                                    "[treasuredata]\n",
                                    "name=TreasureData\n",
                                    "baseurl=http://packages.treasuredata.com/2/redhat/$releasever/$basearch\n",
                                    "gpgcheck=1\n",
                                    "gpgkey=https://packages.treasuredata.com/GPG-KEY-td-agent\n"
                                ]]},
                                "mode" : "000644",
                                "owner" : "root",
                                "group" : "root"
                            },
                            "/tmp/jdk-8u77-linux-x64.rpm" : {
                                "source" : { "Fn::FindInMap" : [ "ContentToURL", "jdk-8u77", "URL" ]},
                                "mode" : "000644",
                                "owner" : "root",
                                "group" : "root"
                            }
                        },
                        "commands" : {
                            "import_td-agent_GPG-KEY" : {
                                "command" : "rpm --import https://packages.treasuredata.com/GPG-KEY-td-agent"
                            }
                        }
                    },
                    "Install" : {
                        "packages" : {
                            "yum" : {
                                "dstat" : [],
                                "td-agent": []
                            }
                        },
                        "commands" : {
                            "install_jdk" : {
                                "command" : "rpm -i /tmp/jdk-8u77-linux-x64.rpm"
                            }
                        }
                    },
                    "Configure" : {
                        "files" : {
                            "/etc/td-agent/td-agent.conf" : {
                                "content" : { "Fn::Join" : [ "", [
                                    "<source>\n",
                                    "  type dstat\n",
                                    "  tag dstat\n",
                                    "  option -cdnm --tcp --udp\n",
                                    "  delay 10 # sec\n",
                                    "</source>\n",
                                    "\n",
                                    "<match dstat>\n",
                                    "  type copy\n",
                                    "\n",
                                    "  <store>\n",
                                    "    type map\n",
                                    "    tag (\"perf.cpu\")\n",
                                    "    time time\n",
                                    "    record record[\"dstat\"][\"total_cpu_usage\"]\n",
                                    "  </store>\n",
                                    "\n",
                                    "  <store>\n",
                                    "    type map\n",
                                    "    tag (\"perf.dsk\")\n",
                                    "    time time\n",
                                    "    record record[\"dstat\"][\"dsk/total\"]\n",
                                    "  </store>\n",
                                    "\n",
                                    "  <store>\n",
                                    "    type map\n",
                                    "    tag (\"perf.mem\")\n",
                                    "    time time\n",
                                    "    record record[\"dstat\"][\"memory_usage\"]\n",
                                    "  </store>\n",
                                    "\n",
                                    "  <store>\n",
                                    "    type map\n",
                                    "    tag (\"perf.tcp-sockets\")\n",
                                    "    time time\n",
                                    "    record record[\"dstat\"][\"tcp_sockets\"]\n",
                                    "  </store>\n",
                                    "\n",
                                    "  <store>\n",
                                    "    type map\n",
                                    "    tag (\"perf.network\")\n",
                                    "    time time\n",
                                    "    record record[\"dstat\"][\"net/total\"]\n",
                                    "  </store>\n",
                                    "\n",
                                    "  <store>\n",
                                    "    type map\n",
                                    "    tag (\"perf.udp\")\n",
                                    "    time time\n",
                                    "    record record[\"dstat\"][\"udp\"]\n",
                                    "  </store>\n",
                                    "</match>\n",
                                    "\n",
                                    "<match perf.**>\n",
                                    "  type growthforecast\n",
                                    "  gfapi_url ", { "Ref" : "GrowthForecastURL" }, "\n",
                                    "  service dstat\n",
                                    "  tag_for section\n",
                                    "  remove_prefix perf\n",
                                    "  name_key_pattern .*\n",
                                    "</match>\n"
                                ]]},
                                "mode" : "000644",
                                "owner" : "root",
                                "group" : "root"
                            }
                        },
                        "commands" : {
                            "install_plugins" : {
                                "command" : "td-agent-gem install fluent-plugin-growthforecast fluent-plugin-dstat fluent-plugin-map"
                            }
                        }
                    },
                    "Start" : {
                        "services" : {
                            "sysvinit" : {
                                "td-agent" : { "enabled" : "true", "ensureRunning": "true" }
                            }
                        }
                    }
                }
            }
        }
    },
    "Outputs" : {
        "SSHToApiServer" : {
            "Description" : "SSH command to connect the api server via the bastion server",
            "Value" : { "Fn::Join" : [ "", [
                "ssh",
                " -i ~/", { "Ref" : "KeyName" }, ".pem",
                " ", { "Fn::GetAtt" : [ "ApiServer", "PrivateIp" ]}
            ]]}
        }
    }
}
